var W=Object.create,I=Object.defineProperty,H=Object.defineProperties,V=Object.getOwnPropertyDescriptor,J=Object.getOwnPropertyDescriptors,U=Object.getOwnPropertyNames,R=Object.getOwnPropertySymbols,X=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,L=(e,t,i)=>t in e?I(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,M=(e,t)=>{for(var i in t||(t={}))z.call(t,i)&&L(e,i,t[i]);if(R)for(var i of R(t))K.call(t,i)&&L(e,i,t[i]);return e},j=(e,t)=>H(e,J(t)),G=e=>I(e,"__esModule",{value:!0}),A=(e,t)=>function(){return t||(0,e[U(e)[0]])((t={exports:{}}).exports,t),t.exports},Z=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of U(t))!z.call(e,a)&&(i||a!=="default")&&I(e,a,{get:()=>t[a],enumerable:!(s=V(t,a))||s.enumerable});return e},E=(e,t)=>Z(G(I(e!=null?W(X(e)):{},"default",!t&&e&&e.__esModule?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e),B=(e,t,i)=>new Promise((s,a)=>{var c=f=>{try{g(i.next(f))}catch(n){a(n)}},l=f=>{try{g(i.throw(f))}catch(n){a(n)}},g=f=>f.done?s(f.value):Promise.resolve(f.value).then(c,l);g((i=i.apply(e,t)).next())}),F=A({"node_modules/peerjs-js-binarypack/lib/bufferbuilder.js"(e,t){var i={};i.useBlobBuilder=function(){try{return new Blob([]),!1}catch{return!0}}(),i.useArrayBufferView=!i.useBlobBuilder&&function(){try{return new Blob([new Uint8Array([])]).size===0}catch{return!0}}(),t.exports.binaryFeatures=i;var s=t.exports.BlobBuilder;typeof window!="undefined"&&(s=t.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder);function a(){this._pieces=[],this._parts=[]}a.prototype.append=function(c){typeof c=="number"?this._pieces.push(c):(this.flush(),this._parts.push(c))},a.prototype.flush=function(){if(this._pieces.length>0){var c=new Uint8Array(this._pieces);i.useArrayBufferView||(c=c.buffer),this._parts.push(c),this._pieces=[]}},a.prototype.getBuffer=function(){if(this.flush(),i.useBlobBuilder){for(var c=new s,l=0,g=this._parts.length;l<g;l++)c.append(this._parts[l]);return c.getBlob()}else return new Blob(this._parts)},t.exports.BufferBuilder=a}}),ee=A({"node_modules/peerjs-js-binarypack/lib/binarypack.js"(e,t){var i=F().BufferBuilder,s=F().binaryFeatures,a={unpack:function(n){var r=new c(n);return r.unpack()},pack:function(n){var r=new l;r.pack(n);var o=r.getBuffer();return o}};t.exports=a;function c(n){this.index=0,this.dataBuffer=n,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}c.prototype.unpack=function(){var n=this.unpack_uint8();if(n<128)return n;if((n^224)<32)return(n^224)-32;var r;if((r=n^160)<=15)return this.unpack_raw(r);if((r=n^176)<=15)return this.unpack_string(r);if((r=n^144)<=15)return this.unpack_array(r);if((r=n^128)<=15)return this.unpack_map(r);switch(n){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return;case 213:return;case 214:return;case 215:return;case 216:return r=this.unpack_uint16(),this.unpack_string(r);case 217:return r=this.unpack_uint32(),this.unpack_string(r);case 218:return r=this.unpack_uint16(),this.unpack_raw(r);case 219:return r=this.unpack_uint32(),this.unpack_raw(r);case 220:return r=this.unpack_uint16(),this.unpack_array(r);case 221:return r=this.unpack_uint32(),this.unpack_array(r);case 222:return r=this.unpack_uint16(),this.unpack_map(r);case 223:return r=this.unpack_uint32(),this.unpack_map(r)}},c.prototype.unpack_uint8=function(){var n=this.dataView[this.index]&255;return this.index++,n},c.prototype.unpack_uint16=function(){var n=this.read(2),r=(n[0]&255)*256+(n[1]&255);return this.index+=2,r},c.prototype.unpack_uint32=function(){var n=this.read(4),r=((n[0]*256+n[1])*256+n[2])*256+n[3];return this.index+=4,r},c.prototype.unpack_uint64=function(){var n=this.read(8),r=((((((n[0]*256+n[1])*256+n[2])*256+n[3])*256+n[4])*256+n[5])*256+n[6])*256+n[7];return this.index+=8,r},c.prototype.unpack_int8=function(){var n=this.unpack_uint8();return n<128?n:n-(1<<8)},c.prototype.unpack_int16=function(){var n=this.unpack_uint16();return n<32768?n:n-(1<<16)},c.prototype.unpack_int32=function(){var n=this.unpack_uint32();return n<Math.pow(2,31)?n:n-Math.pow(2,32)},c.prototype.unpack_int64=function(){var n=this.unpack_uint64();return n<Math.pow(2,63)?n:n-Math.pow(2,64)},c.prototype.unpack_raw=function(n){if(this.length<this.index+n)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+n+" "+this.length);var r=this.dataBuffer.slice(this.index,this.index+n);return this.index+=n,r},c.prototype.unpack_string=function(n){for(var r=this.read(n),o=0,u="",p,_;o<n;)p=r[o],p<128?(u+=String.fromCharCode(p),o++):(p^192)<32?(_=(p^192)<<6|r[o+1]&63,u+=String.fromCharCode(_),o+=2):(_=(p&15)<<12|(r[o+1]&63)<<6|r[o+2]&63,u+=String.fromCharCode(_),o+=3);return this.index+=n,u},c.prototype.unpack_array=function(n){for(var r=new Array(n),o=0;o<n;o++)r[o]=this.unpack();return r},c.prototype.unpack_map=function(n){for(var r={},o=0;o<n;o++){var u=this.unpack(),p=this.unpack();r[u]=p}return r},c.prototype.unpack_float=function(){var n=this.unpack_uint32(),r=n>>31,o=(n>>23&255)-127,u=n&8388607|8388608;return(r===0?1:-1)*u*Math.pow(2,o-23)},c.prototype.unpack_double=function(){var n=this.unpack_uint32(),r=this.unpack_uint32(),o=n>>31,u=(n>>20&2047)-1023,p=n&1048575|1048576,_=p*Math.pow(2,u-20)+r*Math.pow(2,u-52);return(o===0?1:-1)*_},c.prototype.read=function(n){var r=this.index;if(r+n<=this.length)return this.dataView.subarray(r,r+n);throw new Error("BinaryPackFailure: read index out of range")};function l(){this.bufferBuilder=new i}l.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()},l.prototype.pack=function(n){var r=typeof n;if(r==="string")this.pack_string(n);else if(r==="number")Math.floor(n)===n?this.pack_integer(n):this.pack_double(n);else if(r==="boolean")n===!0?this.bufferBuilder.append(195):n===!1&&this.bufferBuilder.append(194);else if(r==="undefined")this.bufferBuilder.append(192);else if(r==="object")if(n===null)this.bufferBuilder.append(192);else{var o=n.constructor;if(o==Array)this.pack_array(n);else if(o==Blob||o==File||n instanceof Blob||n instanceof File)this.pack_bin(n);else if(o==ArrayBuffer)s.useArrayBufferView?this.pack_bin(new Uint8Array(n)):this.pack_bin(n);else if("BYTES_PER_ELEMENT"in n)s.useArrayBufferView?this.pack_bin(new Uint8Array(n.buffer)):this.pack_bin(n.buffer);else if(o==Object||o.toString().startsWith("class"))this.pack_object(n);else if(o==Date)this.pack_string(n.toString());else if(typeof n.toBinaryPack=="function")this.bufferBuilder.append(n.toBinaryPack());else throw new Error('Type "'+o.toString()+'" not yet supported')}else throw new Error('Type "'+r+'" not yet supported');this.bufferBuilder.flush()},l.prototype.pack_bin=function(n){var r=n.length||n.byteLength||n.size;if(r<=15)this.pack_uint8(160+r);else if(r<=65535)this.bufferBuilder.append(218),this.pack_uint16(r);else if(r<=4294967295)this.bufferBuilder.append(219),this.pack_uint32(r);else throw new Error("Invalid length");this.bufferBuilder.append(n)},l.prototype.pack_string=function(n){var r=f(n);if(r<=15)this.pack_uint8(176+r);else if(r<=65535)this.bufferBuilder.append(216),this.pack_uint16(r);else if(r<=4294967295)this.bufferBuilder.append(217),this.pack_uint32(r);else throw new Error("Invalid length");this.bufferBuilder.append(n)},l.prototype.pack_array=function(n){var r=n.length;if(r<=15)this.pack_uint8(144+r);else if(r<=65535)this.bufferBuilder.append(220),this.pack_uint16(r);else if(r<=4294967295)this.bufferBuilder.append(221),this.pack_uint32(r);else throw new Error("Invalid length");for(var o=0;o<r;o++)this.pack(n[o])},l.prototype.pack_integer=function(n){if(n>=-32&&n<=127)this.bufferBuilder.append(n&255);else if(n>=0&&n<=255)this.bufferBuilder.append(204),this.pack_uint8(n);else if(n>=-128&&n<=127)this.bufferBuilder.append(208),this.pack_int8(n);else if(n>=0&&n<=65535)this.bufferBuilder.append(205),this.pack_uint16(n);else if(n>=-32768&&n<=32767)this.bufferBuilder.append(209),this.pack_int16(n);else if(n>=0&&n<=4294967295)this.bufferBuilder.append(206),this.pack_uint32(n);else if(n>=-2147483648&&n<=2147483647)this.bufferBuilder.append(210),this.pack_int32(n);else if(n>=-9223372036854776e3&&n<=9223372036854776e3)this.bufferBuilder.append(211),this.pack_int64(n);else if(n>=0&&n<=18446744073709552e3)this.bufferBuilder.append(207),this.pack_uint64(n);else throw new Error("Invalid integer")},l.prototype.pack_double=function(n){var r=0;n<0&&(r=1,n=-n);var o=Math.floor(Math.log(n)/Math.LN2),u=n/Math.pow(2,o)-1,p=Math.floor(u*Math.pow(2,52)),_=Math.pow(2,32),y=r<<31|o+1023<<20|p/_&1048575,k=p%_;this.bufferBuilder.append(203),this.pack_int32(y),this.pack_int32(k)},l.prototype.pack_object=function(n){var r=Object.keys(n),o=r.length;if(o<=15)this.pack_uint8(128+o);else if(o<=65535)this.bufferBuilder.append(222),this.pack_uint16(o);else if(o<=4294967295)this.bufferBuilder.append(223),this.pack_uint32(o);else throw new Error("Invalid length");for(var u in n)n.hasOwnProperty(u)&&(this.pack(u),this.pack(n[u]))},l.prototype.pack_uint8=function(n){this.bufferBuilder.append(n)},l.prototype.pack_uint16=function(n){this.bufferBuilder.append(n>>8),this.bufferBuilder.append(n&255)},l.prototype.pack_uint32=function(n){var r=n&4294967295;this.bufferBuilder.append((r&4278190080)>>>24),this.bufferBuilder.append((r&16711680)>>>16),this.bufferBuilder.append((r&65280)>>>8),this.bufferBuilder.append(r&255)},l.prototype.pack_uint64=function(n){var r=n/Math.pow(2,32),o=n%Math.pow(2,32);this.bufferBuilder.append((r&4278190080)>>>24),this.bufferBuilder.append((r&16711680)>>>16),this.bufferBuilder.append((r&65280)>>>8),this.bufferBuilder.append(r&255),this.bufferBuilder.append((o&4278190080)>>>24),this.bufferBuilder.append((o&16711680)>>>16),this.bufferBuilder.append((o&65280)>>>8),this.bufferBuilder.append(o&255)},l.prototype.pack_int8=function(n){this.bufferBuilder.append(n&255)},l.prototype.pack_int16=function(n){this.bufferBuilder.append((n&65280)>>8),this.bufferBuilder.append(n&255)},l.prototype.pack_int32=function(n){this.bufferBuilder.append(n>>>24&255),this.bufferBuilder.append((n&16711680)>>>16),this.bufferBuilder.append((n&65280)>>>8),this.bufferBuilder.append(n&255)},l.prototype.pack_int64=function(n){var r=Math.floor(n/Math.pow(2,32)),o=n%Math.pow(2,32);this.bufferBuilder.append((r&4278190080)>>>24),this.bufferBuilder.append((r&16711680)>>>16),this.bufferBuilder.append((r&65280)>>>8),this.bufferBuilder.append(r&255),this.bufferBuilder.append((o&4278190080)>>>24),this.bufferBuilder.append((o&16711680)>>>16),this.bufferBuilder.append((o&65280)>>>8),this.bufferBuilder.append(o&255)};function g(n){var r=n.charCodeAt(0);return r<=2047?"00":r<=65535?"000":r<=2097151?"0000":r<=67108863?"00000":"000000"}function f(n){return n.length>600?new Blob([n]).size:n.replace(/[^\u0000-\u007F]/g,g).length}}}),P=A({"node_modules/eventemitter3/index.js"(e,t){var i=Object.prototype.hasOwnProperty,s="~";function a(){}Object.create&&(a.prototype=Object.create(null),new a().__proto__||(s=!1));function c(n,r,o){this.fn=n,this.context=r,this.once=o||!1}function l(n,r,o,u,p){if(typeof o!="function")throw new TypeError("The listener must be a function");var _=new c(o,u||n,p),y=s?s+r:r;return n._events[y]?n._events[y].fn?n._events[y]=[n._events[y],_]:n._events[y].push(_):(n._events[y]=_,n._eventsCount++),n}function g(n,r){--n._eventsCount===0?n._events=new a:delete n._events[r]}function f(){this._events=new a,this._eventsCount=0}f.prototype.eventNames=function(){var r=[],o,u;if(this._eventsCount===0)return r;for(u in o=this._events)i.call(o,u)&&r.push(s?u.slice(1):u);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(o)):r},f.prototype.listeners=function(r){var o=s?s+r:r,u=this._events[o];if(!u)return[];if(u.fn)return[u.fn];for(var p=0,_=u.length,y=new Array(_);p<_;p++)y[p]=u[p].fn;return y},f.prototype.listenerCount=function(r){var o=s?s+r:r,u=this._events[o];return u?u.fn?1:u.length:0},f.prototype.emit=function(r,o,u,p,_,y){var k=s?s+r:r;if(!this._events[k])return!1;var d=this._events[k],w=arguments.length,m,v;if(d.fn){switch(d.once&&this.removeListener(r,d.fn,void 0,!0),w){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,o),!0;case 3:return d.fn.call(d.context,o,u),!0;case 4:return d.fn.call(d.context,o,u,p),!0;case 5:return d.fn.call(d.context,o,u,p,_),!0;case 6:return d.fn.call(d.context,o,u,p,_,y),!0}for(v=1,m=new Array(w-1);v<w;v++)m[v-1]=arguments[v];d.fn.apply(d.context,m)}else{var Y=d.length,S;for(v=0;v<Y;v++)switch(d[v].once&&this.removeListener(r,d[v].fn,void 0,!0),w){case 1:d[v].fn.call(d[v].context);break;case 2:d[v].fn.call(d[v].context,o);break;case 3:d[v].fn.call(d[v].context,o,u);break;case 4:d[v].fn.call(d[v].context,o,u,p);break;default:if(!m)for(S=1,m=new Array(w-1);S<w;S++)m[S-1]=arguments[S];d[v].fn.apply(d[v].context,m)}}return!0},f.prototype.on=function(r,o,u){return l(this,r,o,u,!1)},f.prototype.once=function(r,o,u){return l(this,r,o,u,!0)},f.prototype.removeListener=function(r,o,u,p){var _=s?s+r:r;if(!this._events[_])return this;if(!o)return g(this,_),this;var y=this._events[_];if(y.fn)y.fn===o&&(!p||y.once)&&(!u||y.context===u)&&g(this,_);else{for(var k=0,d=[],w=y.length;k<w;k++)(y[k].fn!==o||p&&!y[k].once||u&&y[k].context!==u)&&d.push(y[k]);d.length?this._events[_]=d.length===1?d[0]:d:g(this,_)}return this},f.prototype.removeAllListeners=function(r){var o;return r?(o=s?s+r:r,this._events[o]&&g(this,o)):(this._events=new a,this._eventsCount=0),this},f.prototype.off=f.prototype.removeListener,f.prototype.addListener=f.prototype.on,f.prefixed=s,f.EventEmitter=f,typeof t!="undefined"&&(t.exports=f)}}),$=E(ee()),te={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:0.peerjs.com:3478",username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},b=new class{constructor(){this.CLOUD_HOST="0.peerjs.com",this.CLOUD_PORT=443,this.chunkedMTU=16300,this.defaultConfig=te,this.pack=$.pack,this.unpack=$.unpack,this._dataCount=1}validateId(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(e)}chunk(e){const t=[],i=e.size,s=Math.ceil(i/b.chunkedMTU);let a=0,c=0;for(;c<i;){const l=Math.min(i,c+b.chunkedMTU),g=e.slice(c,l),f={__peerData:this._dataCount,n:a,data:g,total:s};t.push(f),c=l,a++}return this._dataCount++,t}blobToArrayBuffer(e,t,i){const s=new e;return s.onload=function(a){a.target&&i(a.target.result)},s.readAsArrayBuffer(t),s}binaryStringToArrayBuffer(e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i)&255;return t.buffer}randomToken(){return Math.random().toString(36).substr(2)}isSecure(){return location.protocol==="https:"}},ne=E(P()),ie="PeerJS: ",re=class{constructor(){this._logLevel=0}get logLevel(){return this._logLevel}set logLevel(e){this._logLevel=e}log(...e){this._logLevel>=3&&this._print(3,...e)}warn(...e){this._logLevel>=2&&this._print(2,...e)}error(...e){this._logLevel>=1&&this._print(1,...e)}setLogFunction(e){this._print=e}_print(e,...t){const i=[ie,...t];for(let s in i)i[s]instanceof Error&&(i[s]="("+i[s].name+") "+i[s].message);e>=3?console.log(...i):e>=2?console.warn("WARNING",...i):e>=1&&console.error("ERROR",...i)}},h=new re,se=E(P()),oe=class extends se.EventEmitter{constructor({secure:e,host:t,port:i,path:s,key:a,pingInterval:c=5e3,polyfills:l}){super(),this._disconnected=!0,this._id=null,this._messagesQueue=[],this.alive=!1,this._destroyed=!1;var g;this.pingInterval=c;const f=e?"wss://":"ws://";this._baseUrl=f+t+":"+i+s+"peerjs?key="+a,this.WebSocketConstructor=(g=l==null?void 0:l.WebSocket)!=null?g:window.WebSocket}get messagesQueue(){return this._messagesQueue}get destroyed(){return this._destroyed}start(e,t){if(this._destroyed)throw new Error("Socket was destroyed!");if(this._id=e,!!this._socket||!this._disconnected)return;const i=`${this._baseUrl}&id=${e}&token=${t}`;this._socket=new this.WebSocketConstructor(i),this._disconnected=!1,this._socket.onmessage=s=>{if(this._destroyed)return;let a;try{a=JSON.parse(s.data),h.log("Server message received:",a)}catch{h.log("Invalid server message",s.data);return}this.emit("message",a)},this._socket.onclose=s=>{this._disconnected||this._destroyed||(h.log("Socket closed.",s),this._cleanup(),this._disconnected=!0,this.emit("disconnected"))},this._socket.onopen=()=>{this._disconnected||this._destroyed||(h.log("Socket open"),this.emit("open"),this._sendQueuedMessages(),this._scheduleHeartbeat())}}_scheduleHeartbeat(){this._wsPingTimer=setTimeout(()=>{this._sendHeartbeat()},this.pingInterval)}_sendHeartbeat(){if(this._destroyed)return;if(!this._wsOpen()){h.log("Cannot send heartbeat, because socket closed");return}const e=JSON.stringify({type:"HEARTBEAT"});this._socket.send(e),this._scheduleHeartbeat()}_wsOpen(){return!!this._socket&&this._socket.readyState===1}_sendQueuedMessages(){const e=[...this._messagesQueue];this._messagesQueue=[];for(const t of e)this.send(t);e.length>0&&h.log(`${e.length} queued messages was sent`)}send(e){if(this._destroyed)throw new Error("Socket was destroyed!");if(!e.type){this.emit("error","Invalid message");return}if(!this.alive)return;if(this._id==null||!this._wsOpen()){this._messagesQueue.push(e);return}const t=JSON.stringify(e);this._socket.send(t)}close(){this._disconnected||(this._cleanup(),this._id=null,this._disconnected=!0)}_cleanup(){this._socket&&(this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0),clearTimeout(this._wsPingTimer)}destroy(){this._destroyed||(this.close(),this._messagesQueue.length=0,this._destroyed=!0)}};function ae(){}var N=class{constructor(e){this.connection=e}get webRtc(){var e,t;return(t=(e=this.connection.provider.options.polyfills)==null?void 0:e.WebRTC)!=null?t:window}startConnection(e){const t=this._startPeerConnection();if(this.connection.peerConnection=t,this.connection.type==="media"&&e._stream&&this._addTracksToConnection(e._stream,t),e.originator){if(this.connection.type==="data"){const i=this.connection,s={ordered:!!e.reliable},a=t.createDataChannel(i.label,s);i.initialize(a)}this._makeOffer()}else this.handleSDP("OFFER",e.sdp)}_startPeerConnection(){h.log("Creating RTCPeerConnection.");const e=this.webRtc.RTCPeerConnection,t=new e(this.connection.provider.options.config);return this._setupListeners(t),t}_setupListeners(e){const t=this.connection.peer,i=this.connection.connectionId,s=this.connection.type,a=this.connection.provider;h.log("Listening for ICE candidates, remote streams and data channels."),e.onicecandidate=c=>{!c.candidate||!c.candidate.candidate||(h.log(`Received ICE candidates for ${t}:`,c.candidate),a.socket.send({type:"CANDIDATE",payload:{candidate:c.candidate,type:s,connectionId:i},dst:t}))},e.oniceconnectionstatechange=()=>{switch(e.iceConnectionState){case"failed":h.log("iceConnectionState is failed, closing connections to "+t),this.connection.emit("error",new Error("Negotiation of connection to "+t+" failed.")),this.connection.close();break;case"closed":h.log("iceConnectionState is closed, closing connections to "+t),this.connection.emit("error",new Error("Connection to "+t+" closed.")),this.connection.close();break;case"connected":h.log("iceConnectionState changed to connected on the connection with "+t);break;case"disconnected":h.log("iceConnectionState changed to disconnected on the connection with "+t);break;case"completed":h.log("iceConnectionState changed to completed on the connection with "+t),e.onicecandidate=ae;break}this.connection.emit("iceStateChanged",e.iceConnectionState)},e.ondatachannel=c=>{h.log("Received data channel");const l=c.channel;a.getConnection(t,i).initialize(l)},e.ontrack=c=>{h.log("Received remote stream");const l=c.streams[0],g=a.getConnection(t,i);if(g.type==="media"){const f=g;this._addStreamToMediaConnection(l,f)}}}cleanup(){h.log("Cleaning up PeerConnection to "+this.connection.peer);const e=this.connection.peerConnection;if(!e)return;this.connection.peerConnection=null,e.onicecandidate=e.oniceconnectionstatechange=e.ondatachannel=e.ontrack=null;const t=e.signalingState!=="closed";let i=!1;if(this.connection.type==="data"){const a=this.connection.dataChannel;a&&(i=!!a.readyState&&a.readyState!=="closed")}(t||i)&&e.close()}_makeOffer(){return B(this,null,function*(){const e=this.connection.peerConnection,t=this.connection.provider;try{const i=yield e.createOffer(this.connection.options.constraints);if(e.signalingState==="closed")return;h.log("Created offer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp);try{yield e.setLocalDescription(i),h.log("Set localDescription:",i,`for:${this.connection.peer}`);let s={sdp:i,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata};if(this.connection.type==="data"){const a=this.connection;s=j(M({},s),{label:a.label,reliable:a.reliable,serialization:a.serialization})}t.socket.send({type:"OFFER",payload:s,dst:this.connection.peer})}catch(s){s!="OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer"&&(t.emitError("webrtc",s),h.log("Failed to setLocalDescription, ",s))}}catch(i){t.emitError("webrtc",i),h.log("Failed to createOffer, ",i)}})}_makeAnswer(){return B(this,null,function*(){const e=this.connection.peerConnection,t=this.connection.provider;try{const i=yield e.createAnswer();if(e.signalingState==="closed")return;h.log("Created answer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp);try{yield e.setLocalDescription(i),h.log("Set localDescription:",i,`for:${this.connection.peer}`),t.socket.send({type:"ANSWER",payload:{sdp:i,type:this.connection.type,connectionId:this.connection.connectionId},dst:this.connection.peer})}catch(s){t.emitError("webrtc",s),h.log("Failed to setLocalDescription, ",s)}}catch(i){t.emitError("webrtc",i),h.log("Failed to create answer, ",i)}})}handleSDP(e,t){return B(this,null,function*(){const i=this.webRtc.RTCSessionDescription;t=new i(t);const s=this.connection.peerConnection,a=this.connection.provider;h.log("Setting remote description",t);const c=this;try{yield s.setRemoteDescription(t),h.log(`Set remoteDescription:${e} for:${this.connection.peer}`),e==="OFFER"&&(yield c._makeAnswer())}catch(l){a.emitError("webrtc",l),h.log("Failed to setRemoteDescription, ",l)}})}handleCandidate(e){return B(this,null,function*(){h.log("handleCandidate:",e);const t=e.candidate,i=e.sdpMLineIndex,s=e.sdpMid,a=this.connection.peerConnection,c=this.connection.provider;try{const l=this.webRtc.RTCIceCandidate;yield a.addIceCandidate(new l({sdpMid:s,sdpMLineIndex:i,candidate:t})),h.log(`Added ICE candidate for:${this.connection.peer}`)}catch(l){c.emitError("webrtc",l),h.log("Failed to handleCandidate, ",l)}})}_addTracksToConnection(e,t){if(h.log(`add tracks from stream ${e.id} to peer connection`),!t.addTrack)return h.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");e.getTracks().forEach(i=>{t.addTrack(i,e)})}_addStreamToMediaConnection(e,t){h.log(`add stream ${e.id} to media connection ${t.connectionId}`),t.addStream(e)}},ce=E(P()),Q=class extends ce.EventEmitter{constructor(e,t,i){super(),this.peer=e,this.provider=t,this.options=i,this._open=!1,this.metadata=i.metadata}get open(){return this._open}},q=class extends Q{get type(){return"media"}get localStream(){return this._localStream}get remoteStream(){return this._remoteStream}constructor(e,t,i){super(e,t,i),this._localStream=this.options._stream,this.connectionId=this.options.connectionId||q.ID_PREFIX+b.randomToken(),this._negotiator=new N(this),this._localStream&&this._negotiator.startConnection({_stream:this._localStream,originator:!0})}addStream(e){h.log("Receiving stream",e),this._remoteStream=e,super.emit("stream",e)}handleMessage(e){const t=e.type,i=e.payload;switch(e.type){case"ANSWER":this._negotiator.handleSDP(t,i.sdp),this._open=!0;break;case"CANDIDATE":this._negotiator.handleCandidate(i.candidate);break;default:h.warn(`Unrecognized message type:${t} from peer:${this.peer}`);break}}answer(e,t={}){if(this._localStream){h.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");return}this._localStream=e,t&&t.sdpTransform&&(this.options.sdpTransform=t.sdpTransform),this._negotiator.startConnection(j(M({},this.options._payload),{_stream:e}));const i=this.provider._getMessages(this.connectionId);for(let s of i)this.handleMessage(s);this._open=!0}close(){this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this._localStream=null,this._remoteStream=null,this.provider&&(this.provider._removeConnection(this),this.provider=null),this.options&&this.options._stream&&(this.options._stream=null),this.open&&(this._open=!1,super.emit("close"))}},D=q;D.ID_PREFIX="mc_";var he=E(P()),ue=class extends he.EventEmitter{constructor(e){super(),this.fileReader=e,this._queue=[],this._processing=!1,this.fileReader.onload=t=>{this._processing=!1,t.target&&this.emit("done",t.target.result),this.doNextTask()},this.fileReader.onerror=t=>{h.error("EncodingQueue error:",t),this._processing=!1,this.destroy(),this.emit("error",t)}}get queue(){return this._queue}get size(){return this.queue.length}get processing(){return this._processing}enque(e){this.queue.push(e),!this.processing&&this.doNextTask()}destroy(){this.fileReader.abort(),this._queue=[]}doNextTask(){this.size!==0&&(this.processing||(this._processing=!0,this.fileReader.readAsArrayBuffer(this.queue.shift())))}},O=class extends Q{constructor(e,t,i){super(e,t,i),this.stringify=JSON.stringify,this.parse=JSON.parse,this._buffer=[],this._bufferSize=0,this._buffering=!1,this._chunkedData={};var s,a;this.connectionId=this.options.connectionId||O.ID_PREFIX+b.randomToken(),this.label=this.options.label||this.connectionId,this.serialization=this.options.serialization||"binary",this.reliable=!!this.options.reliable,this.FileReaderCtr=(a=(s=t.options.polyfills)==null?void 0:s.FileReader)!=null?a:window.FileReader,this._encodingQueue=new ue(new this.FileReaderCtr),this._encodingQueue.on("done",c=>{this._bufferedSend(c)}),this._encodingQueue.on("error",()=>{h.error(`DC#${this.connectionId}: Error occured in encoding from blob to arraybuffer, close DC`),this.close()}),this._negotiator=new N(this),this._negotiator.startConnection(this.options._payload||{originator:!0})}get type(){return"data"}get dataChannel(){return this._dc}get bufferSize(){return this._bufferSize}initialize(e){this._dc=e,this._configureDataChannel()}_configureDataChannel(){(!this.provider.features.binaryBlob||this.provider.features.reliable)&&(this.dataChannel.binaryType="arraybuffer"),this.dataChannel.onopen=()=>{h.log(`DC#${this.connectionId} dc connection success`),this._open=!0,this.emit("open")},this.dataChannel.onmessage=e=>{h.log(`DC#${this.connectionId} dc onmessage:`,e.data),this._handleDataMessage(e)},this.dataChannel.onclose=()=>{h.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}_handleDataMessage({data:e}){const t=e.constructor,i=this.serialization==="binary"||this.serialization==="binary-utf8";let s=e;if(i){if(t===Blob){b.blobToArrayBuffer(this.FileReaderCtr,e,a=>{const c=b.unpack(a);this.emit("data",c)});return}else if(t===ArrayBuffer)s=b.unpack(e);else if(t===String){const a=b.binaryStringToArrayBuffer(e);s=b.unpack(a)}}else this.serialization==="json"&&(s=this.parse(e));if(s.__peerData){this._handleChunk(s);return}super.emit("data",s)}_handleChunk(e){const t=e.__peerData,i=this._chunkedData[t]||{data:[],count:0,total:e.total};if(i.data[e.n]=e.data,i.count++,this._chunkedData[t]=i,i.total===i.count){delete this._chunkedData[t];const s=new Blob(i.data);this._handleDataMessage({data:s})}}close(){this._buffer=[],this._bufferSize=0,this._chunkedData={},this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this.provider&&(this.provider._removeConnection(this),this.provider=null),this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this._dc=null),this._encodingQueue&&(this._encodingQueue.destroy(),this._encodingQueue.removeAllListeners(),this._encodingQueue=null),this.open&&(this._open=!1,super.emit("close"))}send(e,t){if(!this.open){super.emit("error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));return}if(this.serialization==="json")this._bufferedSend(this.stringify(e));else if(this.serialization==="binary"||this.serialization==="binary-utf8"){const i=b.pack(e);if(!t&&i.size>b.chunkedMTU){this._sendChunks(i);return}this.provider.features.binaryBlob?this._bufferedSend(i):this._encodingQueue.enque(i)}else this._bufferedSend(e)}_bufferedSend(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this._bufferSize=this._buffer.length)}_trySend(e){if(!this.open)return!1;if(this.dataChannel.bufferedAmount>O.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout(()=>{this._buffering=!1,this._tryBuffer()},50),!1;try{this.dataChannel.send(e)}catch(t){return h.error(`DC#:${this.connectionId} Error when sending:`,t),this._buffering=!0,this.close(),!1}return!0}_tryBuffer(){if(!this.open||this._buffer.length===0)return;const e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer())}_sendChunks(e){const t=b.chunk(e);h.log(`DC#${this.connectionId} Try to send ${t.length} chunks...`);for(let i of t)this.send(i,!0)}handleMessage(e){const t=e.payload;switch(e.type){case"ANSWER":this._negotiator.handleSDP(e.type,t.sdp);break;case"CANDIDATE":this._negotiator.handleCandidate(t.candidate);break;default:h.warn("Unrecognized message type:",e.type,"from peer:",this.peer);break}}},T=O;T.ID_PREFIX="dc_";T.MAX_BUFFERED_AMOUNT=8*1024*1024;var le=class{constructor(e){this._options=e}_request(e){var t,i;return((i=(t=this._options.polyfills)==null?void 0:t.fetch)!=null?i:window.fetch)(e)}_buildUrl(e){let i=(this._options.secure?"https://":"http://")+this._options.host+":"+this._options.port+this._options.path+this._options.key+"/"+e;return i+="?ts="+new Date().getTime()+Math.random(),i}retrieveId(){return B(this,null,function*(){const e=this._buildUrl("id");try{const t=yield this._request(e);if(t.status!==200)throw new Error(`Error. Status:${t.status}`);return t.text()}catch(t){h.error("Error retrieving ID",t);let i="";throw this._options.path==="/"&&this._options.host!==b.CLOUD_HOST&&(i=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),new Error("Could not get an ID from the server."+i)}})}listAllPeers(){return B(this,null,function*(){const e=this._buildUrl("peers");try{const t=yield this._request(e);if(t.status!==200){if(t.status===401){let i="";throw this._options.host===b.CLOUD_HOST?i="It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":i="You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+i)}throw new Error(`Error. Status:${t.status}`)}return t.json()}catch(t){throw h.error("Error retrieving list peers",t),new Error("Could not get list peers from the server."+t)}})}},de={isUnifiedPlanSupported(e){if(!e&&typeof window!="undefined"&&(e=window),typeof e.RTCRtpTransceiver=="undefined"||!("currentDirection"in e.RTCRtpTransceiver.prototype))return!1;let t,i=!1;try{t=new e.RTCPeerConnection,t.addTransceiver("audio"),i=!0}catch{}finally{t&&t.close()}return i}},C=class extends ne.EventEmitter{constructor(e,t){super(),this._id=null,this._lastServerId=null,this._destroyed=!1,this._disconnected=!1,this._open=!1,this._connections=new Map,this._lostMessages=new Map;var i;let s;if(e&&e.constructor==Object?t=e:e&&(s=e.toString()),t=M({debug:0,host:b.CLOUD_HOST,port:b.CLOUD_PORT,path:"/",key:C.DEFAULT_KEY,token:b.randomToken(),config:b.defaultConfig},t),this._options=t,typeof window!="undefined"&&this._options.host==="/"&&(this._options.host=window.location.hostname),this._options.path&&(this._options.path[0]!=="/"&&(this._options.path="/"+this._options.path),this._options.path[this._options.path.length-1]!=="/"&&(this._options.path+="/")),this._options.secure===void 0&&this._options.host!==b.CLOUD_HOST?this._options.secure=b.isSecure():this._options.host==b.CLOUD_HOST&&(this._options.secure=!0),this._options.logFunction&&h.setLogFunction(this._options.logFunction),h.logLevel=this._options.debug||0,this._api=new le(t),this._socket=this._createServerConnection(),this.features=C.getFeatures((i=this._options.polyfills)==null?void 0:i.WebRTC),!this.features.audioVideo&&!this.features.data){this._delayedAbort("browser-incompatible","The current browser does not support WebRTC");return}if(!!s&&!b.validateId(s)){this._delayedAbort("invalid-id",`ID "${s}" is invalid`);return}this.socket.alive=!0,s?this._initialize(s):this._api.retrieveId().then(a=>this._initialize(a)).catch(a=>this._abort("server-error",a))}get id(){return this._id}get options(){return this._options}get open(){return this._open}get socket(){return this._socket}get connections(){const e=Object.create(null);for(let[t,i]of this._connections)e[t]=i;return e}get destroyed(){return this._destroyed}get disconnected(){return this._disconnected}_createServerConnection(){const e=new oe(this._options);return e.on("message",t=>{this._handleMessage(t)}),e.on("error",t=>{this._abort("socket-error",t)}),e.on("disconnected",()=>{this.disconnected||(this.emitError("network","Lost connection to server."),this.disconnect())}),e.on("close",()=>{this.disconnected||this._abort("socket-closed","Underlying socket is already closed.")}),e}_initialize(e){this.destroyed||(this._id=e,this.socket.start(e,this._options.token))}_handleMessage(e){const t=e.type,i=e.payload,s=e.src;switch(t){case"OPEN":this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case"ERROR":this._abort("server-error",i.msg);break;case"ID-TAKEN":this._abort("unavailable-id",`ID "${this.id}" is taken`);break;case"INVALID-KEY":this._abort("invalid-key",`API KEY "${this._options.key}" is invalid`);break;case"LEAVE":h.log(`Received leave message from ${s}`),this._cleanupPeer(s),this._connections.delete(s);break;case"EXPIRE":this.emitError("peer-unavailable",`Could not connect to peer ${s}`);break;case"OFFER":{const a=i.connectionId;let c=this.getConnection(s,a);if(c&&(c.close(),h.warn(`Offer received for existing Connection ID:${a}`)),i.type==="media")c=new D(s,this,{connectionId:a,_payload:i,metadata:i.metadata}),this._addConnection(s,c),this.emit("call",c);else if(i.type==="data")c=new T(s,this,{connectionId:a,_payload:i,metadata:i.metadata,label:i.label,serialization:i.serialization,reliable:i.reliable}),this._addConnection(s,c),this.emit("connection",c);else{h.warn(`Received malformed connection type:${i.type}`);return}const l=this._getMessages(a);for(let g of l)c.handleMessage(g);break}default:{if(!i){h.warn(`You received a malformed message from ${s} of type ${t}`);return}const a=i.connectionId,c=this.getConnection(s,a);c&&c.peerConnection?c.handleMessage(e):a?this._storeMessage(a,e):h.warn("You received an unrecognized message:",e);break}}}_storeMessage(e,t){this._lostMessages.has(e)||this._lostMessages.set(e,[]),this._lostMessages.get(e).push(t)}_getMessages(e){const t=this._lostMessages.get(e);return t?(this._lostMessages.delete(e),t):[]}connect(e,t={}){if(this.disconnected){h.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");return}const i=new T(e,this,t);return this._addConnection(e,i),i}call(e,t,i={}){if(this.disconnected){h.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");return}if(!t){h.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");return}i._stream=t;const s=new D(e,this,i);return this._addConnection(e,s),s}_addConnection(e,t){h.log(`add connection ${t.type}:${t.connectionId} to peerId:${e}`),this._connections.has(e)||this._connections.set(e,[]),this._connections.get(e).push(t)}_removeConnection(e){const t=this._connections.get(e.peer);if(t){const i=t.indexOf(e);i!==-1&&(t.splice(i,1),t.length===0&&this._connections.delete(e.peer))}this._lostMessages.delete(e.connectionId)}getConnection(e,t){const i=this._connections.get(e);if(!i)return null;for(let s of i)if(s.connectionId===t)return s;return null}_delayedAbort(e,t){setTimeout(()=>{this._abort(e,t)},0)}_abort(e,t){h.error("Aborting!"),this.emitError(e,t),this._lastServerId?this.disconnect():this.destroy()}emitError(e,t){h.error("Error:",t);let i;typeof t=="string"?i=new Error(t):i=t,i.type=e,this.emit("error",i)}destroy(){this.destroyed||(h.log(`Destroy peer with ID:${this.id}`),this.disconnect(),this._cleanup(),this.socket.destroy(),this._destroyed=!0,this.emit("close"))}_cleanup(){for(let e of this._connections.keys())this._cleanupPeer(e),this._connections.delete(e);this.socket.removeAllListeners()}_cleanupPeer(e){const t=this._connections.get(e);if(!!t)for(let i of t)i.close()}disconnect(){if(this.disconnected)return;const e=this.id;h.log(`Disconnect peer with ID:${e}`),this._disconnected=!0,this._open=!1,this.socket.alive=!1,this.socket.close(),this._lastServerId=e,this._id=null,this.emit("disconnected",e)}reconnect(){if(this.disconnected&&!this.destroyed)h.log(`Attempting reconnection to server with ID ${this._lastServerId}`),this._disconnected=!1,this.socket.alive=!0,this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(!this.disconnected&&!this.open)h.error("In a hurry? We're still trying to make the initial connection!");else throw new Error(`Peer ${this.id} cannot reconnect because it is not disconnected from the server!`)}}listAllPeers(e=t=>{}){this._api.listAllPeers().then(t=>e(t)).catch(t=>this._abort("server-error",t))}static getFeatures(e){return!e&&typeof window!="undefined"&&(e=window),C._features||(C._features=C.checkFeatures(e)),C._features}static checkFeatures(e){!e&&typeof window!="undefined"&&(e=window);const t={webRTC:typeof e.RTCPeerConnection!="undefined",audioVideo:!0,data:!1,binaryBlob:!1,reliable:!1,unifiedPlan:!1};if(!t.webRTC)return t;let i;try{i=new e.RTCPeerConnection(b.defaultConfig);let s;try{s=i.createDataChannel("_PEERJSTEST",{ordered:!0}),t.data=!0,t.reliable=!!s.ordered;try{s.binaryType="blob",t.binaryBlob=!0}catch{}}catch{}finally{s&&s.close()}}catch{}finally{i&&i.close()}return t.unifiedPlan=de.isUnifiedPlanSupported(e),t}},x=C;x.DEFAULT_KEY="peerjs";var fe=x;typeof window!="undefined"&&(window.Peer=x);export{x as Peer,b as Utils,fe as default};
